(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{272:function(a,t,s){"use strict";s.r(t);var e=s(37),n=Object(e.a)({},function(){var a=this,t=a.$createElement,s=a._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"flagger-install-on-gke-istio"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#flagger-install-on-gke-istio","aria-hidden":"true"}},[a._v("#")]),a._v(" Flagger Install on GKE Istio")]),a._v(" "),s("p",[a._v("This guide walks you through setting up Flagger and Istio on Google Kubernetes Engine.")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/weaveworks/flagger/master/docs/diagrams/flagger-gke-istio.png",alt:"GKE Cluster Overview"}})]),a._v(" "),s("h2",{attrs:{id:"prerequisites"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#prerequisites","aria-hidden":"true"}},[a._v("#")]),a._v(" Prerequisites")]),a._v(" "),s("p",[a._v("You will be creating a cluster on Google’s Kubernetes Engine (GKE), if you don’t have an account you can sign up "),s("a",{attrs:{href:"https://cloud.google.com/free/",target:"_blank",rel:"noopener noreferrer"}},[a._v("here"),s("OutboundLink")],1),a._v(" for free credits.")]),a._v(" "),s("p",[a._v("Login into Google Cloud, create a project and enable billing for it.")]),a._v(" "),s("p",[a._v("Install the "),s("a",{attrs:{href:"https://cloud.google.com/sdk/",target:"_blank",rel:"noopener noreferrer"}},[a._v("gcloud"),s("OutboundLink")],1),a._v(" command line utility and configure your project with "),s("code",[a._v("gcloud init")]),a._v(".")]),a._v(" "),s("p",[a._v("Set the default project (replace "),s("code",[a._v("PROJECT_ID")]),a._v(" with your own project):")]),a._v(" "),s("div",{staticClass:"language-text extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("gcloud config set project PROJECT_ID\n")])])]),s("p",[a._v("Set the default compute region and zone:")]),a._v(" "),s("div",{staticClass:"language-text extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("gcloud config set compute/region us-central1\ngcloud config set compute/zone us-central1-a\n")])])]),s("p",[a._v("Enable the Kubernetes and Cloud DNS services for your project:")]),a._v(" "),s("div",{staticClass:"language-text extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("gcloud services enable container.googleapis.com\ngcloud services enable dns.googleapis.com\n")])])]),s("p",[a._v("Install the kubectl command-line tool:")]),a._v(" "),s("div",{staticClass:"language-text extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("gcloud components install kubectl\n")])])]),s("h2",{attrs:{id:"gke-cluster-setup"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#gke-cluster-setup","aria-hidden":"true"}},[a._v("#")]),a._v(" GKE cluster setup")]),a._v(" "),s("p",[a._v("Create a cluster with the Istio add-on:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("K8S_VERSION")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),a._v("gcloud container get-server-config --format"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("json "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" jq -r "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'.validMasterVersions[0]'")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n\ngcloud beta container clusters create istio "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--cluster-version"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${K8S_VERSION}")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--zone"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("us-central1-a "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--num-nodes"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--machine-type"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("n1-highcpu-4 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--preemptible "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--no-enable-cloud-logging "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--no-enable-cloud-monitoring "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--disk-size"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("30")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--enable-autorepair "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--addons"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("HorizontalPodAutoscaling,Istio "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--istio-config"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("auth"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("MTLS_PERMISSIVE\n")])])]),s("p",[a._v("The above command will create a default node pool consisting of two "),s("code",[a._v("n1-highcpu-4")]),a._v(" (vCPU: 4, RAM 3.60GB, DISK: 30GB) preemptible VMs. Preemptible VMs are up to 80% cheaper than regular instances and are terminated and replaced after a maximum of 24 hours.")]),a._v(" "),s("p",[a._v("Set up credentials for "),s("code",[a._v("kubectl")]),a._v(":")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("gcloud container clusters get-credentials istio\n")])])]),s("p",[a._v("Create a cluster admin role binding:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("kubectl create clusterrolebinding "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"cluster-admin-'),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("whoami")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--clusterrole"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("cluster-admin "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--user"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),a._v("gcloud config get-value core/account"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v('"')]),a._v("\n")])])]),s("p",[a._v("Validate your setup with:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("kubectl -n istio-system get svc\n")])])]),s("p",[a._v("In a couple of seconds GCP should allocate an external IP to the "),s("code",[a._v("istio-ingressgateway")]),a._v(" service.")]),a._v(" "),s("h2",{attrs:{id:"cloud-dns-setup"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cloud-dns-setup","aria-hidden":"true"}},[a._v("#")]),a._v(" Cloud DNS setup")]),a._v(" "),s("p",[a._v("You will need an internet domain and access to the registrar to change the name servers to Google Cloud DNS.")]),a._v(" "),s("p",[a._v("Create a managed zone named "),s("code",[a._v("istio")]),a._v(" in Cloud DNS (replace "),s("code",[a._v("example.com")]),a._v(" with your domain):")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("gcloud dns managed-zones create "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--dns-name"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"example.com."')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--description"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Istio zone"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"istio"')]),a._v("\n")])])]),s("p",[a._v("Look up your zone's name servers:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("gcloud dns managed-zones describe istio\n")])])]),s("p",[a._v("Update your registrar's name server records with the records returned by the above command.")]),a._v(" "),s("p",[a._v("Wait for the name servers to change (replace "),s("code",[a._v("example.com")]),a._v(" with your domain):")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("watch")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("dig")]),a._v(" +short NS example.com\n")])])]),s("p",[a._v("Create a static IP address named "),s("code",[a._v("istio-gateway")]),a._v(" using the Istio ingress IP:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("GATEWAY_IP")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),a._v("kubectl -n istio-system get svc/istio-ingressgateway -ojson "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" jq -r .status.loadBalancer.ingress"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(".ip"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n\ngcloud compute addresses create istio-gateway --addresses "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${GATEWAY_IP}")]),a._v(" --region us-central1\n")])])]),s("p",[a._v("Create the following DNS records (replace "),s("code",[a._v("example.com")]),a._v(" with your domain):")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("DOMAIN")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"example.com"')]),a._v("\n\ngcloud dns record-sets transaction start --zone"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("istio\n\ngcloud dns record-sets transaction "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("add")]),a._v(" --zone"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("istio "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--name"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${DOMAIN}")]),a._v('"')]),a._v(" --ttl"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("300")]),a._v(" --type"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("A "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${GATEWAY_IP}")]),a._v("\n\ngcloud dns record-sets transaction "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("add")]),a._v(" --zone"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("istio "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--name"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"www.'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${DOMAIN}")]),a._v('"')]),a._v(" --ttl"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("300")]),a._v(" --type"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("A "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${GATEWAY_IP}")]),a._v("\n\ngcloud dns record-sets transaction "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("add")]),a._v(" --zone"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("istio "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--name"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"*.'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${DOMAIN}")]),a._v('"')]),a._v(" --ttl"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("300")]),a._v(" --type"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("A "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${GATEWAY_IP}")]),a._v("\n\ngcloud dns record-sets transaction execute --zone istio\n")])])]),s("p",[a._v("Verify that the wildcard DNS is working (replace "),s("code",[a._v("example.com")]),a._v(" with your domain):")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("watch")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("host")]),a._v(" test.example.com\n")])])]),s("h2",{attrs:{id:"install-helm"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#install-helm","aria-hidden":"true"}},[a._v("#")]),a._v(" Install Helm")]),a._v(" "),s("p",[a._v("Install the "),s("a",{attrs:{href:"https://docs.helm.sh/using_helm/#installing-helm",target:"_blank",rel:"noopener noreferrer"}},[a._v("Helm"),s("OutboundLink")],1),a._v(" command-line tool:")]),a._v(" "),s("div",{staticClass:"language-text extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("brew install kubernetes-helm\n")])])]),s("p",[a._v("Create a service account and a cluster role binding for Tiller:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("kubectl -n kube-system create sa tiller\n\nkubectl create clusterrolebinding tiller-cluster-rule "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--clusterrole"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("cluster-admin "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--serviceaccount"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("kube-system:tiller\n")])])]),s("p",[a._v("Deploy Tiller in the "),s("code",[a._v("kube-system")]),a._v(" namespace:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("helm init --service-account tiller\n")])])]),s("p",[a._v("You should consider using SSL between Helm and Tiller, for more information on securing your Helm installation see "),s("a",{attrs:{href:"https://docs.helm.sh/using_helm/#securing-your-helm-installation",target:"_blank",rel:"noopener noreferrer"}},[a._v("docs.helm.sh"),s("OutboundLink")],1),a._v(".")]),a._v(" "),s("h2",{attrs:{id:"install-cert-manager"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#install-cert-manager","aria-hidden":"true"}},[a._v("#")]),a._v(" Install cert-manager")]),a._v(" "),s("p",[a._v("Jetstack's "),s("a",{attrs:{href:"https://github.com/jetstack/cert-manager",target:"_blank",rel:"noopener noreferrer"}},[a._v("cert-manager"),s("OutboundLink")],1),a._v(" is a Kubernetes operator that automatically creates and manages TLS certs issued by Let’s Encrypt.")]),a._v(" "),s("p",[a._v("You'll be using cert-manager to provision a wildcard certificate for the Istio ingress gateway.")]),a._v(" "),s("p",[a._v("Install cert-manager's CRDs:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("CERT_REPO")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("https://raw.githubusercontent.com/jetstack/cert-manager\n\nkubectl apply -f "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${CERT_REPO}")]),a._v("/release-0.10/deploy/manifests/00-crds.yaml\n")])])]),s("p",[a._v("Create the cert-manager namespace and disable resource validation:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("kubectl create namespace cert-manager\n\nkubectl label namespace cert-manager certmanager.k8s.io/disable-validation"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("true\n")])])]),s("p",[a._v("Install cert-manager with Helm:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("helm repo "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("add")]),a._v(" jetstack https://charts.jetstack.io "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&&")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\nhelm repo update "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&&")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\nhelm upgrade -i cert-manager "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--namespace cert-manager "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--version v0.10.0 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\njetstack/cert-manager\n")])])]),s("h2",{attrs:{id:"istio-gateway-tls-setup"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#istio-gateway-tls-setup","aria-hidden":"true"}},[a._v("#")]),a._v(" Istio Gateway TLS setup")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/weaveworks/flagger/master/docs/diagrams/istio-cert-manager-gke.png",alt:"Istio Let's Encrypt"}})]),a._v(" "),s("p",[a._v("Create a generic Istio Gateway to expose services outside the mesh on HTTPS:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("REPO")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("https://raw.githubusercontent.com/weaveworks/flagger/master\n\nkubectl apply -f "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${REPO}")]),a._v("/artifacts/gke/istio-gateway.yaml\n")])])]),s("p",[a._v("Create a service account with Cloud DNS admin role (replace "),s("code",[a._v("my-gcp-project")]),a._v(" with your project ID):")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("GCP_PROJECT")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("my-gcp-project\n\ngcloud iam service-accounts create dns-admin "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--display-name"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("dns-admin "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--project"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${GCP_PROJECT}")]),a._v("\n\ngcloud iam service-accounts keys create ./gcp-dns-admin.json "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--iam-account"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("dns-admin@"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${GCP_PROJECT}")]),a._v(".iam.gserviceaccount.com "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--project"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${GCP_PROJECT}")]),a._v("\n\ngcloud projects add-iam-policy-binding "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${GCP_PROJECT}")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--member"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("serviceAccount:dns-admin@"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${GCP_PROJECT}")]),a._v(".iam.gserviceaccount.com "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--role"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("roles/dns.admin\n")])])]),s("p",[a._v("Create a Kubernetes secret with the GCP Cloud DNS admin key:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("kubectl create secret generic cert-manager-credentials "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--from-file"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("./gcp-dns-admin.json "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--namespace"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("istio-system\n")])])]),s("p",[a._v("Create a letsencrypt issuer for CloudDNS (replace "),s("code",[a._v("email@example.com")]),a._v(" with a valid email address and "),s("code",[a._v("my-gcp-project")]),a._v("with your project ID):")]),a._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" certmanager.k8s.io/v1alpha1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" Issuer\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" letsencrypt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("prod\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("namespace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" istio"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("system\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("acme")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("server")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" https"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("//acme"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("v02.api.letsencrypt.org/directory\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("email")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" email@example.com\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("privateKeySecretRef")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" letsencrypt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("prod\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("dns01")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("providers")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" cloud"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("dns\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("clouddns")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n          "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("serviceAccountSecretRef")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" cert"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("manager"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("credentials\n            "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("key")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" gcp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("dns"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("admin.json\n          "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("project")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" my"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("gcp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("project\n")])])]),s("p",[a._v("Save the above resource as letsencrypt-issuer.yaml and then apply it:")]),a._v(" "),s("div",{staticClass:"language-text extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("kubectl apply -f ./letsencrypt-issuer.yaml\n")])])]),s("p",[a._v("Create a wildcard certificate (replace "),s("code",[a._v("example.com")]),a._v(" with your domain):")]),a._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" certmanager.k8s.io/v1alpha1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" Certificate\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" istio"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("gateway\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("namespace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" istio"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("system\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("secretName")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" istio"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("ingressgateway"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("certs\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("issuerRef")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" letsencrypt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("prod\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("commonName")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"*.example.com"')]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("acme")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("config")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("dns01")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("provider")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" cloud"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("dns\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("domains")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"*.example.com"')]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"example.com"')]),a._v("\n")])])]),s("p",[a._v("Save the above resource as istio-gateway-cert.yaml and then apply it:")]),a._v(" "),s("div",{staticClass:"language-text extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("kubectl apply -f ./istio-gateway-cert.yaml\n")])])]),s("p",[a._v("In a couple of seconds cert-manager should fetch a wildcard certificate from letsencrypt.org:")]),a._v(" "),s("div",{staticClass:"language-text extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("kubectl -n istio-system describe certificate istio-gateway\n\nEvents:\n  Type    Reason         Age    From          Message\n  ----    ------         ----   ----          -------\n  Normal  CertIssued     1m52s  cert-manager  Certificate issued successfully\n")])])]),s("p",[a._v("Recreate Istio ingress gateway pods:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("kubectl -n istio-system get pods -l "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("istio")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("ingressgateway\n")])])]),s("p",[a._v("Note that Istio gateway doesn't reload the certificates from the TLS secret on cert-manager renewal. Since the GKE cluster is made out of preemptible VMs the gateway pods will be replaced once every 24h, if your not using preemptible nodes then you need to manually delete the gateway pods every two months before the certificate expires.")]),a._v(" "),s("h2",{attrs:{id:"install-prometheus"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#install-prometheus","aria-hidden":"true"}},[a._v("#")]),a._v(" Install Prometheus")]),a._v(" "),s("p",[a._v("The GKE Istio add-on does not include a Prometheus instance that scrapes the Istio telemetry service. Because Flagger uses the Istio HTTP metrics to run the canary analysis you have to deploy the following Prometheus configuration that's similar to the one that comes with the official Istio Helm chart.")]),a._v(" "),s("p",[a._v("Find the GKE Istio version with:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("kubectl -n istio-system get deploy istio-pilot -oyaml "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("grep")]),a._v(" image:\n")])])]),s("p",[a._v("Install Prometheus in istio-system namespace:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("kubectl -n istio-system apply -f "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\nhttps://storage.googleapis.com/gke-release/istio/release/1.0.6-gke.3/patches/install-prometheus.yaml\n")])])]),s("h2",{attrs:{id:"install-flagger-and-grafana"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#install-flagger-and-grafana","aria-hidden":"true"}},[a._v("#")]),a._v(" Install Flagger and Grafana")]),a._v(" "),s("p",[a._v("Add Flagger Helm repository:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("helm repo "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("add")]),a._v(" flagger https://flagger.app\n")])])]),s("p",[a._v("Install Flagger's Canary CRD:")]),a._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[a._v("kubectl apply "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("f https"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("//raw.githubusercontent.com/weaveworks/flagger/master/artifacts/flagger/crd.yaml\n")])])]),s("p",[a._v("Deploy Flagger in the "),s("code",[a._v("istio-system")]),a._v(" namespace with Slack notifications enabled:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("helm upgrade -i flagger flagger/flagger "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--namespace"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("istio-system "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--set crd.create"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("false "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--set "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("metricsServer")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("http://prometheus.istio-system:9090 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--set slack.url"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--set slack.channel"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("general "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--set slack.user"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("flagger\n")])])]),s("p",[a._v("Deploy Grafana in the "),s("code",[a._v("istio-system")]),a._v(" namespace:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("helm upgrade -i flagger-grafana flagger/grafana "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--namespace"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("istio-system "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--set "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("url")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("http://prometheus.istio-system:9090 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--set "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("user")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("admin "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--set "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("password")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("replace-me\n")])])]),s("p",[a._v("Expose Grafana through the public gateway by creating a virtual service (replace "),s("code",[a._v("example.com")]),a._v(" with your domain):")]),a._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" networking.istio.io/v1alpha3\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" VirtualService\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" grafana\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("namespace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" istio"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("system\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("hosts")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"grafana.example.com"')]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("gateways")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" public"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("gateway.istio"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("system.svc.cluster.local\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("http")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("route")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("destination")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("host")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" flagger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("grafana\n")])])]),s("p",[a._v("Save the above resource as grafana-virtual-service.yaml and then apply it:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("kubectl apply -f ./grafana-virtual-service.yaml\n")])])]),s("p",[a._v("Navigate to "),s("code",[a._v("http://grafana.example.com")]),a._v(" in your browser and you should be redirected to the HTTPS version.")])])},[],!1,null,null,null);t.default=n.exports}}]);