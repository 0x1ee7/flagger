(window.webpackJsonp=window.webpackJsonp||[]).push([[31],{291:function(e,t,a){"use strict";a.r(t);var s=a(37),n=Object(s.a)({},function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"deployment-strategies"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#deployment-strategies","aria-hidden":"true"}},[e._v("#")]),e._v(" Deployment Strategies")]),e._v(" "),a("p",[e._v("Flagger can run automated application analysis, promotion and rollback for the following deployment strategies:")]),e._v(" "),a("ul",[a("li",[a("strong",[e._v("Canary Release")]),e._v(" (progressive traffic shifting)\n"),a("ul",[a("li",[e._v("Istio, Linkerd, App Mesh, NGINX, Contour, Gloo")])])]),e._v(" "),a("li",[a("strong",[e._v("A/B Testing")]),e._v(" (HTTP headers and cookies traffic routing)\n"),a("ul",[a("li",[e._v("Istio, App Mesh, NGINX, Contour")])])]),e._v(" "),a("li",[a("strong",[e._v("Blue/Green")]),e._v(" (traffic switching)\n"),a("ul",[a("li",[e._v("Kubernetes CNI, Istio, Linkerd, App Mesh, NGINX, Contour, Gloo")])])]),e._v(" "),a("li",[a("strong",[e._v("Blue/Green Mirroring")]),e._v(" (traffic shadowing)\n"),a("ul",[a("li",[e._v("Istio")])])])]),e._v(" "),a("p",[e._v("For Canary releases and A/B testing you'll need a Layer 7 traffic management solution like a service mesh or an ingress controller.\nFor Blue/Green deployments no service mesh or ingress controller is required.")]),e._v(" "),a("p",[e._v("A canary analysis is triggered by changes in any of the following objects:")]),e._v(" "),a("ul",[a("li",[e._v("Deployment PodSpec (container image, command, ports, env, resources, etc)")]),e._v(" "),a("li",[e._v("ConfigMaps mounted as volumes or mapped to environment variables")]),e._v(" "),a("li",[e._v("Secrets mounted as volumes or mapped to environment variables")])]),e._v(" "),a("h2",{attrs:{id:"canary-release"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#canary-release","aria-hidden":"true"}},[e._v("#")]),e._v(" Canary Release")]),e._v(" "),a("p",[e._v("Flagger implements a control loop that gradually shifts traffic to the canary while measuring key performance\nindicators like HTTP requests success rate, requests average duration and pod health.\nBased on analysis of the KPIs a canary is promoted or aborted.")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/weaveworks/flagger/master/docs/diagrams/flagger-canary-steps.png",alt:"Flagger Canary Stages"}})]),e._v(" "),a("p",[e._v("The canary analysis runs periodically until it reaches the maximum traffic weight or the failed checks threshold.")]),e._v(" "),a("p",[e._v("Spec:")]),e._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[e._v("  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("analysis")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# schedule interval (default 60s)")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("interval")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" 1m\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# max number of failed metric checks before rollback")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("threshold")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("10")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# max traffic percentage routed to canary")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# percentage (0-100)")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("maxWeight")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("50")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# canary increment step")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# percentage (0-100)")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("stepWeight")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# deploy straight to production without")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# the metrics and webhook checks")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("skipAnalysis")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[e._v("false")]),e._v("\n")])])]),a("p",[e._v("The above analysis, if it succeeds, will run for 25 minutes while validating the HTTP metrics and webhooks every minute.\nYou can determine the minimum time that it takes to validate and promote a canary deployment using this formula:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("interval * (maxWeight / stepWeight)\n")])])]),a("p",[e._v("And the time it takes for a canary to be rollback when the metrics or webhook checks are failing:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("interval * threshold \n")])])]),a("p",[e._v("In emergency cases, you may want to skip the analysis phase and ship changes directly to production.\nAt any time you can set the "),a("code",[e._v("spec.skipAnalysis: true")]),e._v(".\nWhen skip analysis is enabled, Flagger checks if the canary deployment is healthy and\npromotes it without analysing it. If an analysis is underway, Flagger cancels it and runs the promotion.")]),e._v(" "),a("p",[e._v("Gated canary promotion stages:")]),e._v(" "),a("ul",[a("li",[e._v("scan for canary deployments")]),e._v(" "),a("li",[e._v("check primary and canary deployment status\n"),a("ul",[a("li",[e._v("halt advancement if a rolling update is underway")]),e._v(" "),a("li",[e._v("halt advancement if pods are unhealthy")])])]),e._v(" "),a("li",[e._v("call confirm-rollout webhooks and check results\n"),a("ul",[a("li",[e._v("halt advancement if any hook returns a non HTTP 2xx result")])])]),e._v(" "),a("li",[e._v("call pre-rollout webhooks and check results\n"),a("ul",[a("li",[e._v("halt advancement if any hook returns a non HTTP 2xx result")]),e._v(" "),a("li",[e._v("increment the failed checks counter")])])]),e._v(" "),a("li",[e._v("increase canary traffic weight percentage from 0% to 2% (step weight)")]),e._v(" "),a("li",[e._v("call rollout webhooks and check results")]),e._v(" "),a("li",[e._v("check canary HTTP request success rate and latency\n"),a("ul",[a("li",[e._v("halt advancement if any metric is under the specified threshold")]),e._v(" "),a("li",[e._v("increment the failed checks counter")])])]),e._v(" "),a("li",[e._v("check if the number of failed checks reached the threshold\n"),a("ul",[a("li",[e._v("route all traffic to primary")]),e._v(" "),a("li",[e._v("scale to zero the canary deployment and mark it as failed")]),e._v(" "),a("li",[e._v("call post-rollout webhooks")]),e._v(" "),a("li",[e._v("post the analysis result to Slack")]),e._v(" "),a("li",[e._v("wait for the canary deployment to be updated and start over")])])]),e._v(" "),a("li",[e._v("increase canary traffic weight by 2% (step weight) till it reaches 50% (max weight)\n"),a("ul",[a("li",[e._v("halt advancement if any webhook call fails")]),e._v(" "),a("li",[e._v("halt advancement while canary request success rate is under the threshold")]),e._v(" "),a("li",[e._v("halt advancement while canary request duration P99 is over the threshold")]),e._v(" "),a("li",[e._v("halt advancement while any custom metric check fails")]),e._v(" "),a("li",[e._v("halt advancement if the primary or canary deployment becomes unhealthy")]),e._v(" "),a("li",[e._v("halt advancement while canary deployment is being scaled up/down by HPA")])])]),e._v(" "),a("li",[e._v("call confirm-promotion webhooks and check results\n"),a("ul",[a("li",[e._v("halt advancement if any hook returns a non HTTP 2xx result")])])]),e._v(" "),a("li",[e._v("promote canary to primary\n"),a("ul",[a("li",[e._v("copy ConfigMaps and Secrets from canary to primary")]),e._v(" "),a("li",[e._v("copy canary deployment spec template over primary")])])]),e._v(" "),a("li",[e._v("wait for primary rolling update to finish\n"),a("ul",[a("li",[e._v("halt advancement if pods are unhealthy")])])]),e._v(" "),a("li",[e._v("route all traffic to primary")]),e._v(" "),a("li",[e._v("scale to zero the canary deployment")]),e._v(" "),a("li",[e._v("mark rollout as finished")]),e._v(" "),a("li",[e._v("call post-rollout webhooks")]),e._v(" "),a("li",[e._v("send notification with the canary analysis result")]),e._v(" "),a("li",[e._v("wait for the canary deployment to be updated and start over")])]),e._v(" "),a("h2",{attrs:{id:"a-b-testing"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#a-b-testing","aria-hidden":"true"}},[e._v("#")]),e._v(" A/B Testing")]),e._v(" "),a("p",[e._v("For frontend applications that require session affinity you should use HTTP headers or cookies match conditions\nto ensure a set of users will stay on the same version for the whole duration of the canary analysis.")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/weaveworks/flagger/master/docs/diagrams/flagger-abtest-steps.png",alt:"Flagger A/B Testing Stages"}})]),e._v(" "),a("p",[e._v("You can enable A/B testing by specifying the HTTP match conditions and the number of iterations.\nIf Flagger finds a HTTP match condition, it will ignore the "),a("code",[e._v("maxWeight")]),e._v(" and "),a("code",[e._v("stepWeight")]),e._v(" settings.")]),e._v(" "),a("p",[e._v("Istio example:")]),e._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[e._v("  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("analysis")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# schedule interval (default 60s)")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("interval")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" 1m\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# total number of iterations")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("iterations")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("10")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# max number of failed iterations before rollback")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("threshold")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# canary match condition")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("match")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("headers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("x-canary")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("regex")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('".*insider.*"')]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("headers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("cookie")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("regex")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"^(.*?;)?(canary=always)(;.*)?$"')]),e._v("\n")])])]),a("p",[e._v("The above configuration will run an analysis for ten minutes targeting the Safari users and those that have a test cookie.\nYou can determine the minimum time that it takes to validate and promote a canary deployment using this formula:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("interval * iterations\n")])])]),a("p",[e._v("And the time it takes for a canary to be rollback when the metrics or webhook checks are failing:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("interval * threshold \n")])])]),a("p",[e._v("App Mesh example:")]),e._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[e._v("  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("analysis")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("interval")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" 1m\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("threshold")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("10")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("iterations")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("match")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("headers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("user-agent")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("regex")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('".*Chrome.*"')]),e._v("\n")])])]),a("p",[e._v("Note that App Mesh supports a single condition.")]),e._v(" "),a("p",[e._v("Contour example:")]),e._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[e._v("  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("analysis")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("interval")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" 1m\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("threshold")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("10")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("iterations")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("match")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("headers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("user-agent")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("prefix")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Chrome"')]),e._v("\n")])])]),a("p",[e._v("Note that Contour does not support regex, you can use prefix, suffix or exact.")]),e._v(" "),a("p",[e._v("NGINX example:")]),e._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[e._v("  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("analysis")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("interval")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" 1m\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("threshold")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("10")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("iterations")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("match")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("headers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("x-canary")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("exact")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"insider"')]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("headers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("cookie")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("exact")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"canary"')]),e._v("\n")])])]),a("p",[e._v("Note that the NGINX ingress controller supports only exact matching for a single header and the cookie value is set to "),a("code",[e._v("always")]),e._v(".")]),e._v(" "),a("p",[e._v("The above configurations will route users with the x-canary header or canary cookie to the canary instance during analysis:")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[e._v("curl")]),e._v(" -H "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'X-Canary: insider'")]),e._v(" http://app.example.com\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("curl")]),e._v(" -b "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'canary=always'")]),e._v(" http://app.example.com\n")])])]),a("h2",{attrs:{id:"blue-green-deployments"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#blue-green-deployments","aria-hidden":"true"}},[e._v("#")]),e._v(" Blue/Green Deployments")]),e._v(" "),a("p",[e._v("For applications that are not deployed on a service mesh, Flagger can orchestrate blue/green style deployments\nwith Kubernetes L4 networking. When using Istio you have the option to mirror traffic between blue and green.")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/weaveworks/flagger/master/docs/diagrams/flagger-bluegreen-steps.png",alt:"Flagger Blue/Green Stages"}})]),e._v(" "),a("p",[e._v("You can use the blue/green deployment strategy by replacing "),a("code",[e._v("stepWeight/maxWeight")]),e._v(" with "),a("code",[e._v("iterations")]),e._v(" in the "),a("code",[e._v("canaryAnalysis")]),e._v(" spec:")]),e._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[e._v("  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("analysis")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# schedule interval (default 60s)")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("interval")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" 1m\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# total number of iterations")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("iterations")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("10")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# max number of failed iterations before rollback")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("threshold")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),e._v("\n")])])]),a("p",[e._v("With the above configuration Flagger will run conformance and load tests on the canary pods for ten minutes.\nIf the metrics analysis succeeds, live traffic will be switched from the old version to the new one when the\ncanary is promoted.")]),e._v(" "),a("p",[e._v("The blue/green deployment strategy is supported for all service mesh providers.")]),e._v(" "),a("p",[e._v("Blue/Green rollout steps for service mesh:")]),e._v(" "),a("ul",[a("li",[e._v("detect new revision (deployment spec, secrets or configmaps changes)")]),e._v(" "),a("li",[e._v("scale up the canary (green)")]),e._v(" "),a("li",[e._v("run conformance tests for the canary pods")]),e._v(" "),a("li",[e._v("run load tests and metric checks for the canary pods every minute")]),e._v(" "),a("li",[e._v("abort the canary release if the failure threshold is reached")]),e._v(" "),a("li",[e._v("route traffic to canary")]),e._v(" "),a("li",[e._v("promote canary spec over primary (blue)")]),e._v(" "),a("li",[e._v("wait for primary rollout")]),e._v(" "),a("li",[e._v("route traffic to primary")]),e._v(" "),a("li",[e._v("scale down canary")])]),e._v(" "),a("p",[e._v("After the analysis finishes, the traffic is routed to the canary (green) before triggering the primary (blue)\nrolling update, this ensures a smooth transition to the new version avoiding dropping in-flight requests during\nthe Kubernetes deployment rollout.")]),e._v(" "),a("h2",{attrs:{id:"blue-green-with-traffic-mirroring"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#blue-green-with-traffic-mirroring","aria-hidden":"true"}},[e._v("#")]),e._v(" Blue/Green with Traffic Mirroring")]),e._v(" "),a("p",[e._v("Traffic Mirroring is a pre-stage in a Canary (progressive traffic shifting) or\nBlue/Green deployment strategy. Traffic mirroring will copy each incoming\nrequest, sending one request to the primary and one to the canary service.\nThe response from the primary is sent back to the user. The response from the canary\nis discarded.  Metrics are collected on both requests so that the deployment will\nonly proceed if the canary metrics are healthy.")]),e._v(" "),a("p",[e._v("Mirroring should be used for requests that are "),a("strong",[e._v("idempotent")]),e._v(" or capable of\nbeing processed twice (once by the primary and once by the canary). Reads are\nidempotent. Before using mirroring on requests that may be writes, you should\nconsider what will happen if a write is duplicated and handled by the primary\nand canary.")]),e._v(" "),a("p",[e._v("To use mirroring, set "),a("code",[e._v("spec.canaryAnalysis.mirror")]),e._v(" to "),a("code",[e._v("true")]),e._v(".")]),e._v(" "),a("p",[e._v("Istio example:")]),e._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[e._v("  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("analysis")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# schedule interval (default 60s)")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("interval")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" 1m\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# total number of iterations")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("iterations")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("10")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# max number of failed iterations before rollback")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("threshold")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Traffic shadowing (compatible with Istio only)")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("mirror")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[e._v("true")]),e._v("\n")])])]),a("p",[e._v("Mirroring rollout steps for service mesh:")]),e._v(" "),a("ul",[a("li",[e._v("detect new revision (deployment spec, secrets or configmaps changes)")]),e._v(" "),a("li",[e._v("scale from zero the canary deployment")]),e._v(" "),a("li",[e._v("wait for the HPA to set the canary minimum replicas")]),e._v(" "),a("li",[e._v("check canary pods health")]),e._v(" "),a("li",[e._v("run the acceptance tests")]),e._v(" "),a("li",[e._v("abort the canary release if tests fail")]),e._v(" "),a("li",[e._v("start the load tests")]),e._v(" "),a("li",[e._v("mirror traffic from primary to canary")]),e._v(" "),a("li",[e._v("check request success rate and request duration every minute")]),e._v(" "),a("li",[e._v("abort the canary release if the failure threshold is reached")]),e._v(" "),a("li",[e._v("stop traffic mirroring after the number of iterations is reached")]),e._v(" "),a("li",[e._v("route live traffic to the canary pods")]),e._v(" "),a("li",[e._v("promote the canary (update the primary secrets, configmaps and deployment spec)")]),e._v(" "),a("li",[e._v("wait for the primary deployment rollout to finish")]),e._v(" "),a("li",[e._v("wait for the HPA to set the primary minimum replicas")]),e._v(" "),a("li",[e._v("check primary pods health")]),e._v(" "),a("li",[e._v("switch live traffic back to primary")]),e._v(" "),a("li",[e._v("scale to zero the canary")]),e._v(" "),a("li",[e._v("send notification with the canary analysis result")])]),e._v(" "),a("p",[e._v("After the analysis finishes, the traffic is routed to the canary (green) before triggering the primary (blue)\nrolling update, this ensures a smooth transition to the new version avoiding dropping in-flight requests during\nthe Kubernetes deployment rollout.")])])},[],!1,null,null,null);t.default=n.exports}}]);