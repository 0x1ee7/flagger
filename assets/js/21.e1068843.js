(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{281:function(a,t,s){"use strict";s.r(t);var e=s(37),n=Object(e.a)({},function(){var a=this,t=a.$createElement,s=a._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"smi-istio-canary-deployments"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#smi-istio-canary-deployments","aria-hidden":"true"}},[a._v("#")]),a._v(" SMI Istio Canary Deployments")]),a._v(" "),s("p",[a._v("This guide shows you how to use the SMI Istio adapter and Flagger to automate canary deployments.")]),a._v(" "),s("h2",{attrs:{id:"prerequisites"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#prerequisites","aria-hidden":"true"}},[a._v("#")]),a._v(" Prerequisites")]),a._v(" "),s("ul",[s("li",[a._v("Kubernetes > 1.13")]),a._v(" "),s("li",[a._v("Istio > 1.0")])]),a._v(" "),s("h2",{attrs:{id:"install-istio-smi-adapter"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#install-istio-smi-adapter","aria-hidden":"true"}},[a._v("#")]),a._v(" Install Istio SMI adapter")]),a._v(" "),s("p",[a._v("Install the SMI adapter:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("kubectl apply -f https://raw.githubusercontent.com/deislabs/smi-adapter-istio/master/deploy/crds/crds.yaml\nkubectl apply -f https://raw.githubusercontent.com/deislabs/smi-adapter-istio/master/deploy/operator-and-rbac.yaml\n")])])]),s("p",[a._v("Create a generic Istio gateway to expose services outside the mesh on HTTP:")]),a._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" networking.istio.io/v1alpha3\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" Gateway\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" public"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("gateway\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("namespace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" istio"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("system\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("selector")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("istio")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" ingressgateway\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("servers")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("port")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("number")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("80")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" http\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("protocol")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" HTTP\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("hosts")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"*"')]),a._v("\n")])])]),s("p",[a._v("Save the above resource as public-gateway.yaml and then apply it:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("kubectl apply -f ./public-gateway.yaml\n")])])]),s("p",[a._v("Find the Gateway load balancer IP and add a DNS record for it:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("kubectl -n istio-system get svc/istio-ingressgateway -ojson "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" jq -r .status.loadBalancer.ingress"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(".ip\n")])])]),s("h2",{attrs:{id:"install-flagger-and-grafana"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#install-flagger-and-grafana","aria-hidden":"true"}},[a._v("#")]),a._v(" Install Flagger and Grafana")]),a._v(" "),s("p",[a._v("Add Flagger Helm repository:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("helm repo "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("add")]),a._v(" flagger https://flagger.app\n")])])]),s("p",[a._v("Deploy Flagger in the "),s("em",[s("strong",[a._v("istio-system")])]),a._v(" namespace:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("helm upgrade -i flagger flagger/flagger "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--namespace"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("istio-system "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--set "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("meshProvider")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("smi:istio\n")])])]),s("p",[a._v("Flagger comes with a Grafana dashboard made for monitoring the canary deployments.")]),a._v(" "),s("p",[a._v("Deploy Grafana in the "),s("em",[s("strong",[a._v("istio-system")])]),a._v(" namespace:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("helm upgrade -i flagger-grafana flagger/grafana "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--namespace"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("istio-system "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--set "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("url")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("http://prometheus.istio-system:9090\n")])])]),s("p",[a._v("You can access Grafana using port forwarding:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("kubectl -n istio-system port-forward svc/flagger-grafana "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3000")]),a._v(":80\n")])])]),s("h2",{attrs:{id:"workloads-bootstrap"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#workloads-bootstrap","aria-hidden":"true"}},[a._v("#")]),a._v(" Workloads bootstrap")]),a._v(" "),s("p",[a._v("Create a test namespace with Istio sidecar injection enabled:")]),a._v(" "),s("p",[a._v("Create a test namespace and enable Linkerd proxy injection:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("kubectl create ns "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("test")]),a._v("\nkubectl label namespace "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("test")]),a._v(" istio-injection"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("enabled\n")])])]),s("p",[a._v("Create a deployment and a horizontal pod autoscaler:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("kubectl apply -k github.com/weaveworks/flagger//kustomize/podinfo\n")])])]),s("p",[a._v("Deploy the load testing service to generate traffic during the canary analysis:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("kubectl apply -k github.com/weaveworks/flagger//kustomize/tester\n")])])]),s("p",[a._v("Create a canary custom resource (replace example.com with your own domain):")]),a._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" flagger.app/v1beta1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" Canary\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" podinfo\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("namespace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" test\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# deployment reference")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("targetRef")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" apps/v1\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" Deployment\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" podinfo\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# the maximum time in seconds for the canary deployment")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# to make progress before it is rollback (default 600s)")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("progressDeadlineSeconds")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("60")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# HPA reference (optional)")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("autoscalerRef")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" autoscaling/v2beta1\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" HorizontalPodAutoscaler\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" podinfo\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("service")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# container port")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("port")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("9898")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Istio gateways (optional)")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("gateways")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" public"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("gateway.istio"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("system.svc.cluster.local\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Istio virtual service host names (optional)")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("hosts")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" app.example.com\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("analysis")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# schedule interval (default 60s)")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("interval")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" 10s\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# max number of failed metric checks before rollback")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("threshold")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("5")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# max traffic percentage routed to canary")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# percentage (0-100)")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("maxWeight")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("50")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# canary increment step")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# percentage (0-100)")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("stepWeight")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("10")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("metrics")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("success"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("rate\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# minimum req success rate (non 5xx responses)")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# percentage (0-100)")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("thresholdRange")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("min")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("99")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("interval")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" 1m\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("duration\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# maximum req duration P99")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# milliseconds")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("thresholdRange")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("max")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("500")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("interval")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" 30s\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# generate traffic during analysis")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("webhooks")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" load"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("test\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("url")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" http"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("//flagger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("loadtester.test/\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("timeout")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" 5s\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n          "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("cmd")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"hey -z 1m -q 10 -c 2 http://podinfo.test:9898/"')]),a._v("\n")])])]),s("p",[a._v("Save the above resource as podinfo-canary.yaml and then apply it:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("kubectl apply -f ./podinfo-canary.yaml\n")])])]),s("p",[a._v("After a couple of seconds Flagger will create the canary objects:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# applied ")]),a._v("\ndeployment.apps/podinfo\nhorizontalpodautoscaler.autoscaling/podinfo\ncanary.flagger.app/podinfo\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# generated ")]),a._v("\ndeployment.apps/podinfo-primary\nhorizontalpodautoscaler.autoscaling/podinfo-primary\nservice/podinfo\nservice/podinfo-canary\nservice/podinfo-primary\ntrafficsplits.split.smi-spec.io/podinfo\n")])])]),s("h2",{attrs:{id:"automated-canary-promotion"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#automated-canary-promotion","aria-hidden":"true"}},[a._v("#")]),a._v(" Automated canary promotion")]),a._v(" "),s("p",[a._v("Flagger implements a control loop that gradually shifts traffic to the canary while measuring key performance indicators like HTTP requests success rate, requests average duration and pod health. Based on analysis of the KPIs a canary is promoted or aborted, and the analysis result is published to Slack.")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/weaveworks/flagger/master/docs/diagrams/flagger-canary-steps.png",alt:"Flagger Canary Stages"}})]),a._v(" "),s("p",[a._v("Trigger a canary deployment by updating the container image:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("kubectl -n "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("test")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("set")]),a._v(" image deployment/podinfo "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("podinfod")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("quay.io/stefanprodan/podinfo:3.1.1\n")])])]),s("p",[a._v("Flagger detects that the deployment revision changed and starts a new rollout:")]),a._v(" "),s("div",{staticClass:"language-text extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("kubectl -n istio-system logs deployment/flagger -f | jq .msg\n\n\nNew revision detected podinfo.test\nScaling up podinfo.test\nWaiting for podinfo.test rollout to finish: 0 of 1 updated replicas are available\nAdvance podinfo.test canary weight 5\nAdvance podinfo.test canary weight 10\nAdvance podinfo.test canary weight 15\nAdvance podinfo.test canary weight 20\nAdvance podinfo.test canary weight 25\nAdvance podinfo.test canary weight 30\nAdvance podinfo.test canary weight 35\nAdvance podinfo.test canary weight 40\nAdvance podinfo.test canary weight 45\nAdvance podinfo.test canary weight 50\nCopying podinfo.test template spec to podinfo-primary.test\nWaiting for podinfo-primary.test rollout to finish: 1 of 2 updated replicas are available\nPromotion completed! Scaling down podinfo.test\n")])])]),s("p",[s("strong",[a._v("Note")]),a._v(" that if you apply new changes to the deployment during the canary analysis, Flagger will restart the analysis.")]),a._v(" "),s("p",[a._v("During the analysis the canary’s progress can be monitored with Grafana. The Istio dashboard URL is "),s("a",{attrs:{href:"http://localhost:3000/d/flagger-istio/istio-canary?refresh=10s&orgId=1&var-namespace=test&var-primary=podinfo-primary&var-canary=podinfo",target:"_blank",rel:"noopener noreferrer"}},[a._v("http://localhost:3000/d/flagger-istio/istio-canary?refresh=10s&orgId=1&var-namespace=test&var-primary=podinfo-primary&var-canary=podinfo"),s("OutboundLink")],1)]),a._v(" "),s("p",[a._v("You can monitor all canaries with:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("watch")]),a._v(" kubectl get canaries --all-namespaces\n\nNAMESPACE   NAME      STATUS        WEIGHT   LASTTRANSITIONTIME\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("test")]),a._v("        podinfo   Progressing   "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("15")]),a._v("       "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2019")]),a._v("-05-16T14:05:07Z\nprod        frontend  Succeeded     "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("        "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2019")]),a._v("-05-15T16:15:07Z\nprod        backend   Failed        "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("        "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2019")]),a._v("-05-14T17:05:07Z\n")])])]),s("h2",{attrs:{id:"automated-rollback"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#automated-rollback","aria-hidden":"true"}},[a._v("#")]),a._v(" Automated rollback")]),a._v(" "),s("p",[a._v("During the canary analysis you can generate HTTP 500 errors and high latency to test if Flagger pauses the rollout.")]),a._v(" "),s("p",[a._v("Create a tester pod and exec into it:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("kubectl -n "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("test")]),a._v(" run tester "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--image"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("quay.io/stefanprodan/podinfo:3.1.2 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n-- ./podinfo --port"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("9898")]),a._v("\n\nkubectl -n "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("test")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("exec")]),a._v(" -it tester-xx-xx "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sh")]),a._v("\n")])])]),s("p",[a._v("Generate HTTP 500 errors:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("watch")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" http://podinfo-canary:9898/status/500\n")])])]),s("p",[a._v("Generate latency:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("watch")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" http://podinfo-canary:9898/delay/1\n")])])]),s("p",[a._v("When the number of failed checks reaches the canary analysis threshold, the traffic is routed back to the primary, the canary is scaled to zero and the rollout is marked as failed.")]),a._v(" "),s("div",{staticClass:"language-text extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("kubectl -n test describe canary/podinfo\n\nStatus:\n  Canary Weight:         0\n  Failed Checks:         10\n  Phase:                 Failed\nEvents:\n  Type     Reason  Age   From     Message\n  ----     ------  ----  ----     -------\n  Normal   Synced  3m    flagger  Starting canary deployment for podinfo.test\n  Normal   Synced  3m    flagger  Advance podinfo.test canary weight 5\n  Normal   Synced  3m    flagger  Advance podinfo.test canary weight 10\n  Normal   Synced  3m    flagger  Advance podinfo.test canary weight 15\n  Normal   Synced  3m    flagger  Halt podinfo.test advancement success rate 69.17% < 99%\n  Normal   Synced  2m    flagger  Halt podinfo.test advancement success rate 61.39% < 99%\n  Normal   Synced  2m    flagger  Halt podinfo.test advancement success rate 55.06% < 99%\n  Normal   Synced  2m    flagger  Halt podinfo.test advancement success rate 47.00% < 99%\n  Normal   Synced  2m    flagger  (combined from similar events): Halt podinfo.test advancement success rate 38.08% < 99%\n  Warning  Synced  1m    flagger  Rolling back podinfo.test failed checks threshold reached 10\n  Warning  Synced  1m    flagger  Canary failed! Scaling down podinfo.test\n")])])])])},[],!1,null,null,null);t.default=n.exports}}]);