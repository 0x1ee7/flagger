(window.webpackJsonp=window.webpackJsonp||[]).push([[27],{287:function(a,t,e){"use strict";e.r(t);var s=e(37),n=Object(s.a)({},function(){var a=this,t=a.$createElement,e=a._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[e("h1",{attrs:{id:"nginx-canary-deployments"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#nginx-canary-deployments","aria-hidden":"true"}},[a._v("#")]),a._v(" NGINX Canary Deployments")]),a._v(" "),e("p",[a._v("This guide shows you how to use the NGINX ingress controller and Flagger to automate canary deployments and A/B testing.")]),a._v(" "),e("p",[e("img",{attrs:{src:"https://raw.githubusercontent.com/weaveworks/flagger/master/docs/diagrams/flagger-nginx-overview.png",alt:"Flagger NGINX Ingress Controller"}})]),a._v(" "),e("h2",{attrs:{id:"prerequisites"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#prerequisites","aria-hidden":"true"}},[a._v("#")]),a._v(" Prerequisites")]),a._v(" "),e("p",[a._v("Flagger requires a Kubernetes cluster "),e("strong",[a._v("v1.11")]),a._v(" or newer and NGINX ingress "),e("strong",[a._v("0.24")]),a._v(" or newer.")]),a._v(" "),e("p",[a._v("Install NGINX with Helm v3:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("kubectl create ns ingress-nginx\nhelm upgrade -i nginx-ingress stable/nginx-ingress "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--namespace ingress-nginx "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--set controller.stats.enabled"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("true "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--set controller.metrics.enabled"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("true "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--set controller.podAnnotations."),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"prometheus\\.io/scrape"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("true "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--set controller.podAnnotations."),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"prometheus\\.io/port"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("10254")]),a._v("\n")])])]),e("p",[a._v("Install Flagger and the Prometheus add-on in the same namespace as NGINX:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("helm repo "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("add")]),a._v(" flagger https://flagger.app\n\nhelm upgrade -i flagger flagger/flagger "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--namespace ingress-nginx "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--set prometheus.install"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("true "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--set "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("meshProvider")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("nginx\n")])])]),e("p",[a._v("Optionally you can enable Slack notifications:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("helm upgrade -i flagger flagger/flagger "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--reuse-values "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--namespace ingress-nginx "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--set slack.url"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--set slack.channel"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("general "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--set slack.user"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("flagger\n")])])]),e("h2",{attrs:{id:"bootstrap"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#bootstrap","aria-hidden":"true"}},[a._v("#")]),a._v(" Bootstrap")]),a._v(" "),e("p",[a._v("Flagger takes a Kubernetes deployment and optionally a horizontal pod autoscaler (HPA),\nthen creates a series of objects (Kubernetes deployments, ClusterIP services and canary ingress).\nThese objects expose the application outside the cluster and drive the canary analysis and promotion.")]),a._v(" "),e("p",[a._v("Create a test namespace:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("kubectl create ns "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("test")]),a._v("\n")])])]),e("p",[a._v("Create a deployment and a horizontal pod autoscaler:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("kubectl apply -k github.com/weaveworks/flagger//kustomize/podinfo\n")])])]),e("p",[a._v("Deploy the load testing service to generate traffic during the canary analysis:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("helm upgrade -i flagger-loadtester flagger/loadtester "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n--namespace"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("test\n")])])]),e("p",[a._v("Create an ingress definition (replace "),e("code",[a._v("app.example.com")]),a._v(" with your own domain):")]),a._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" extensions/v1beta1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" Ingress\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" podinfo\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("namespace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" test\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("labels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" podinfo\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("annotations")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("kubernetes.io/ingress.class")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"nginx"')]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("rules")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("host")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" app.example.com\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("http")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("paths")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n          "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("backend")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n              "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("serviceName")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" podinfo\n              "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("servicePort")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("80")]),a._v("\n")])])]),e("p",[a._v("Save the above resource as podinfo-ingress.yaml and then apply it:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("kubectl apply -f ./podinfo-ingress.yaml\n")])])]),e("p",[a._v("Create a canary custom resource (replace "),e("code",[a._v("app.example.com")]),a._v(" with your own domain):")]),a._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" flagger.app/v1beta1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" Canary\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" podinfo\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("namespace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" test\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("provider")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" nginx\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# deployment reference")]),a._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("targetRef")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" apps/v1\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" Deployment\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" podinfo\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# ingress reference")]),a._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("ingressRef")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" extensions/v1beta1\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" Ingress\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" podinfo\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# HPA reference (optional)")]),a._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("autoscalerRef")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" autoscaling/v2beta1\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" HorizontalPodAutoscaler\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" podinfo\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# the maximum time in seconds for the canary deployment")]),a._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# to make progress before it is rollback (default 600s)")]),a._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("progressDeadlineSeconds")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("60")]),a._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("service")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# ClusterIP port number")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("80")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# container port number or name")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("targetPort")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("9898")]),a._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("analysis")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# schedule interval (default 60s)")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("interval")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" 10s\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# max number of failed metric checks before rollback")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("threshold")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("10")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# max traffic percentage routed to canary")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# percentage (0-100)")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("maxWeight")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("50")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# canary increment step")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# percentage (0-100)")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("stepWeight")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("5")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# NGINX Prometheus checks")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("metrics")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" request"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("success"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("rate\n      "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# minimum req success rate (non 5xx responses)")]),a._v("\n      "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# percentage (0-100)")]),a._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("thresholdRange")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("min")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("99")]),a._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("interval")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" 1m\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# testing (optional)")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("webhooks")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" acceptance"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("test\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" pre"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("rollout\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("url")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" http"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("//flagger"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("loadtester.test/\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("timeout")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" 30s\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" bash\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("cmd")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v("\"curl -sd 'test' http://podinfo-canary/token | grep token\"")]),a._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" load"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("test\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("url")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" http"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("//flagger"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("loadtester.test/\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("timeout")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" 5s\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("cmd")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"hey -z 1m -q 10 -c 2 http://app.example.com/"')]),a._v("\n")])])]),e("p",[a._v("Save the above resource as podinfo-canary.yaml and then apply it:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("kubectl apply -f ./podinfo-canary.yaml\n")])])]),e("p",[a._v("After a couple of seconds Flagger will create the canary objects:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# applied ")]),a._v("\ndeployment.apps/podinfo\nhorizontalpodautoscaler.autoscaling/podinfo\ningresses.extensions/podinfo\ncanary.flagger.app/podinfo\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# generated ")]),a._v("\ndeployment.apps/podinfo-primary\nhorizontalpodautoscaler.autoscaling/podinfo-primary\nservice/podinfo\nservice/podinfo-canary\nservice/podinfo-primary\ningresses.extensions/podinfo-canary\n")])])]),e("h2",{attrs:{id:"automated-canary-promotion"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#automated-canary-promotion","aria-hidden":"true"}},[a._v("#")]),a._v(" Automated canary promotion")]),a._v(" "),e("p",[a._v("Flagger implements a control loop that gradually shifts traffic to the canary while measuring\nkey performance indicators like HTTP requests success rate, requests average duration and pod health.\nBased on analysis of the KPIs a canary is promoted or aborted, and the analysis result is published to Slack or MS Teams.")]),a._v(" "),e("p",[e("img",{attrs:{src:"https://raw.githubusercontent.com/weaveworks/flagger/master/docs/diagrams/flagger-canary-steps.png",alt:"Flagger Canary Stages"}})]),a._v(" "),e("p",[a._v("Trigger a canary deployment by updating the container image:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("kubectl -n "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("test")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("set")]),a._v(" image deployment/podinfo "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("podinfod")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("stefanprodan/podinfo:3.1.1\n")])])]),e("p",[a._v("Flagger detects that the deployment revision changed and starts a new rollout:")]),a._v(" "),e("div",{staticClass:"language-text extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("kubectl -n test describe canary/podinfo\n\nStatus:\n  Canary Weight:         0\n  Failed Checks:         0\n  Phase:                 Succeeded\nEvents:\n  Type     Reason  Age   From     Message\n  ----     ------  ----  ----     -------\n  Normal   Synced  3m    flagger  New revision detected podinfo.test\n  Normal   Synced  3m    flagger  Scaling up podinfo.test\n  Warning  Synced  3m    flagger  Waiting for podinfo.test rollout to finish: 0 of 1 updated replicas are available\n  Normal   Synced  3m    flagger  Advance podinfo.test canary weight 5\n  Normal   Synced  3m    flagger  Advance podinfo.test canary weight 10\n  Normal   Synced  3m    flagger  Advance podinfo.test canary weight 15\n  Normal   Synced  2m    flagger  Advance podinfo.test canary weight 20\n  Normal   Synced  2m    flagger  Advance podinfo.test canary weight 25\n  Normal   Synced  1m    flagger  Advance podinfo.test canary weight 30\n  Normal   Synced  1m    flagger  Advance podinfo.test canary weight 35\n  Normal   Synced  55s   flagger  Advance podinfo.test canary weight 40\n  Normal   Synced  45s   flagger  Advance podinfo.test canary weight 45\n  Normal   Synced  35s   flagger  Advance podinfo.test canary weight 50\n  Normal   Synced  25s   flagger  Copying podinfo.test template spec to podinfo-primary.test\n  Warning  Synced  15s   flagger  Waiting for podinfo-primary.test rollout to finish: 1 of 2 updated replicas are available\n  Normal   Synced  5s    flagger  Promotion completed! Scaling down podinfo.test\n")])])]),e("p",[e("strong",[a._v("Note")]),a._v(" that if you apply new changes to the deployment during the canary analysis, Flagger will restart the analysis.")]),a._v(" "),e("p",[a._v("You can monitor all canaries with:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[a._v("watch")]),a._v(" kubectl get canaries --all-namespaces\n\nNAMESPACE   NAME      STATUS        WEIGHT   LASTTRANSITIONTIME\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("test")]),a._v("        podinfo   Progressing   "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("15")]),a._v("       "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("2019")]),a._v("-05-06T14:05:07Z\nprod        frontend  Succeeded     "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("        "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("2019")]),a._v("-05-05T16:15:07Z\nprod        backend   Failed        "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("        "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("2019")]),a._v("-05-04T17:05:07Z\n")])])]),e("h2",{attrs:{id:"automated-rollback"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#automated-rollback","aria-hidden":"true"}},[a._v("#")]),a._v(" Automated rollback")]),a._v(" "),e("p",[a._v("During the canary analysis you can generate HTTP 500 errors to test if Flagger pauses and rolls back the faulted version.")]),a._v(" "),e("p",[a._v("Trigger another canary deployment:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("kubectl -n "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("test")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("set")]),a._v(" image deployment/podinfo "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("podinfod")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("stefanprodan/podinfo:3.1.2\n")])])]),e("p",[a._v("Generate HTTP 500 errors:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[a._v("watch")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" http://app.example.com/status/500\n")])])]),e("p",[a._v("When the number of failed checks reaches the canary analysis threshold, the traffic is routed back to the primary,\nthe canary is scaled to zero and the rollout is marked as failed.")]),a._v(" "),e("div",{staticClass:"language-text extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("kubectl -n test describe canary/podinfo\n\nStatus:\n  Canary Weight:         0\n  Failed Checks:         10\n  Phase:                 Failed\nEvents:\n  Type     Reason  Age   From     Message\n  ----     ------  ----  ----     -------\n  Normal   Synced  3m    flagger  Starting canary deployment for podinfo.test\n  Normal   Synced  3m    flagger  Advance podinfo.test canary weight 5\n  Normal   Synced  3m    flagger  Advance podinfo.test canary weight 10\n  Normal   Synced  3m    flagger  Advance podinfo.test canary weight 15\n  Normal   Synced  3m    flagger  Halt podinfo.test advancement success rate 69.17% < 99%\n  Normal   Synced  2m    flagger  Halt podinfo.test advancement success rate 61.39% < 99%\n  Normal   Synced  2m    flagger  Halt podinfo.test advancement success rate 55.06% < 99%\n  Normal   Synced  2m    flagger  Halt podinfo.test advancement success rate 47.00% < 99%\n  Normal   Synced  2m    flagger  (combined from similar events): Halt podinfo.test advancement success rate 38.08% < 99%\n  Warning  Synced  1m    flagger  Rolling back podinfo.test failed checks threshold reached 10\n  Warning  Synced  1m    flagger  Canary failed! Scaling down podinfo.test\n")])])]),e("h2",{attrs:{id:"custom-metrics"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#custom-metrics","aria-hidden":"true"}},[a._v("#")]),a._v(" Custom metrics")]),a._v(" "),e("p",[a._v("The canary analysis can be extended with Prometheus queries.")]),a._v(" "),e("p",[a._v("The demo app is instrumented with Prometheus so you can create a custom check that will use the\nHTTP request duration histogram to validate the canary.")]),a._v(" "),e("p",[a._v("Create a metric template and apply it on the cluster:")]),a._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" flagger.app/v1beta1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" MetricTemplate\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" latency\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("namespace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" test\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("provider")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" prometheus\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("address")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" http"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("//flagger"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("promethues.ingress"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("nginx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("9090")]),a._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("query")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("|")]),e("span",{pre:!0,attrs:{class:"token scalar string"}},[a._v('\n    histogram_quantile(0.99,\n      sum(\n        rate(\n          http_request_duration_seconds_bucket{\n            kubernetes_namespace="{{ namespace }}",\n            kubernetes_pod_name=~"{{ target }}-[0-9a-zA-Z]+(-[0-9a-zA-Z]+)"\n          }[1m]\n        )\n      ) by (le)\n    )')]),a._v("\n")])])]),e("p",[a._v("Edit the canary analysis and add the latency check:")]),a._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[a._v("  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("analysis")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("metrics")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"latency"')]),a._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("templateRef")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" latency\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("thresholdRange")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("max")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("0.5")]),a._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("interval")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" 1m\n")])])]),e("p",[a._v("The threshold is set to 500ms so if the average request duration in the last minute goes over half a second\nthen the analysis will fail and the canary will not be promoted.")]),a._v(" "),e("p",[a._v("Trigger a canary deployment by updating the container image:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("kubectl -n "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("test")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("set")]),a._v(" image deployment/podinfo "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("podinfod")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("stefanprodan/podinfo:3.1.3\n")])])]),e("p",[a._v("Generate high response latency:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[a._v("watch")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" http://app.exmaple.com/delay/2\n")])])]),e("p",[a._v("Watch Flagger logs:")]),a._v(" "),e("div",{staticClass:"language-text extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("kubectl -n nginx-ingress logs deployment/flagger -f | jq .msg\n\nStarting canary deployment for podinfo.test\nAdvance podinfo.test canary weight 5\nAdvance podinfo.test canary weight 10\nAdvance podinfo.test canary weight 15\nHalt podinfo.test advancement latency 1.20 > 0.5\nHalt podinfo.test advancement latency 1.45 > 0.5\nHalt podinfo.test advancement latency 1.60 > 0.5\nHalt podinfo.test advancement latency 1.69 > 0.5\nHalt podinfo.test advancement latency 1.70 > 0.5\nRolling back podinfo.test failed checks threshold reached 5\nCanary failed! Scaling down podinfo.test\n")])])]),e("p",[a._v("If you have alerting configured, Flagger will send a notification with the reason why the canary failed.")]),a._v(" "),e("h2",{attrs:{id:"a-b-testing"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#a-b-testing","aria-hidden":"true"}},[a._v("#")]),a._v(" A/B Testing")]),a._v(" "),e("p",[a._v("Besides weighted routing, Flagger can be configured to route traffic to the canary based on HTTP match conditions.\nIn an A/B testing scenario, you'll be using HTTP headers or cookies to target a certain segment of your users.\nThis is particularly useful for frontend applications that require session affinity.")]),a._v(" "),e("p",[e("img",{attrs:{src:"https://raw.githubusercontent.com/weaveworks/flagger/master/docs/diagrams/flagger-abtest-steps.png",alt:"Flagger A/B Testing Stages"}})]),a._v(" "),e("p",[a._v("Edit the canary analysis, remove the max/step weight and add the match conditions and iterations:")]),a._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[a._v("  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("analysis")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("interval")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" 1m\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("threshold")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("10")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("iterations")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("10")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("match")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# curl -H 'X-Canary: insider' http://app.example.com")]),a._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("headers")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("x-canary")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("exact")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"insider"')]),a._v("\n      "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# curl -b 'canary=always' http://app.example.com")]),a._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("headers")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("cookie")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("exact")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"canary"')]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("metrics")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" request"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("success"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("rate\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("thresholdRange")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("min")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("99")]),a._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("interval")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" 1m\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("webhooks")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" load"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("test\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("url")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" http"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("//flagger"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("loadtester.test/\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("timeout")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" 5s\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("cmd")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v("\"hey -z 1m -q 10 -c 2 -H 'Cookie: canary=always' http://app.example.com/\"")]),a._v("\n")])])]),e("p",[a._v("The above configuration will run an analysis for ten minutes targeting users that have a "),e("code",[a._v("canary")]),a._v(" cookie\nset to "),e("code",[a._v("always")]),a._v(" or those that call the service using the "),e("code",[a._v("X-Canary: insider")]),a._v(" header.")]),a._v(" "),e("p",[a._v("Trigger a canary deployment by updating the container image:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("kubectl -n "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("test")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("set")]),a._v(" image deployment/podinfo "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("podinfod")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("stefanprodan/podinfo:3.1.4\n")])])]),e("p",[a._v("Flagger detects that the deployment revision changed and starts the A/B testing:")]),a._v(" "),e("div",{staticClass:"language-text extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("kubectl -n test describe canary/podinfo\n\nStatus:\n  Failed Checks:         0\n  Phase:                 Succeeded\nEvents:\n  Type     Reason  Age   From     Message\n  ----     ------  ----  ----     -------\n  Normal   Synced  3m    flagger  New revision detected podinfo.test\n  Normal   Synced  3m    flagger  Scaling up podinfo.test\n  Warning  Synced  3m    flagger  Waiting for podinfo.test rollout to finish: 0 of 1 updated replicas are available\n  Normal   Synced  3m    flagger  Advance podinfo.test canary iteration 1/10\n  Normal   Synced  3m    flagger  Advance podinfo.test canary iteration 2/10\n  Normal   Synced  3m    flagger  Advance podinfo.test canary iteration 3/10\n  Normal   Synced  2m    flagger  Advance podinfo.test canary iteration 4/10\n  Normal   Synced  2m    flagger  Advance podinfo.test canary iteration 5/10\n  Normal   Synced  1m    flagger  Advance podinfo.test canary iteration 6/10\n  Normal   Synced  1m    flagger  Advance podinfo.test canary iteration 7/10\n  Normal   Synced  55s   flagger  Advance podinfo.test canary iteration 8/10\n  Normal   Synced  45s   flagger  Advance podinfo.test canary iteration 9/10\n  Normal   Synced  35s   flagger  Advance podinfo.test canary iteration 10/10\n  Normal   Synced  25s   flagger  Copying podinfo.test template spec to podinfo-primary.test\n  Warning  Synced  15s   flagger  Waiting for podinfo-primary.test rollout to finish: 1 of 2 updated replicas are available\n  Normal   Synced  5s    flagger  Promotion completed! Scaling down podinfo.test\n")])])]),e("p",[a._v("The above procedure can be extended with "),e("router-link",{attrs:{to:"/usage/metrics.html"}},[a._v("custom metrics")]),a._v(" checks,\n"),e("router-link",{attrs:{to:"/usage/webhooks.html"}},[a._v("webhooks")]),a._v(",\n"),e("router-link",{attrs:{to:"/usage/webhooks.html#manual-gating"}},[a._v("manual promotion")]),a._v(" approval and\n"),e("router-link",{attrs:{to:"/usage/alerting.html"}},[a._v("Slack or MS Teams")]),a._v(" notifications.")],1)])},[],!1,null,null,null);t.default=n.exports}}]);